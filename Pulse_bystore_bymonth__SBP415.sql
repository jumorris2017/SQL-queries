--SBP415 (PDW)

SELECT 
--sr.CASE_ID
--, sr.QUESTION_ID
  COUNT(CASE WHEN sr.QUESTION_ID = 'Q1' THEN sr.QUESTION_ID END) AS Q1_RESP
, SUM(CASE WHEN sr.RESP_ID = '7' AND sr.QUESTION_ID = 'Q1' THEN 1 ELSE 0 END) AS Q1_TB
, ROUND(AVG(CASE WHEN sr.QUESTION_ID = 'Q1' THEN sr.RESP_ID END),2) AS Q1_AVG
--, TRUNC(sr.SEND_DT)
, p.STORE_NUM 
, c.FSCL_YR_NUM
, c.FSCL_PER_IN_YR_NUM

FROM APPSTG.SRV_RESPONSES_STG sr
  
LEFT JOIN (
   SELECT * FROM (
    SELECT PRTNR_ID, STORE_NUM,
    ROW_NUMBER() OVER (PARTITION BY PRTNR_ID ORDER BY ETL_INSERT_DTM DESC) AS mostrec
    FROM APPSTG.SRV_ACTIVE_PARTNERS_STG
    --WHERE CNTRY_CD = 'US'
    ) WHERE mostrec = 1
  ) p
ON sr.PRTNR_ID = p.PRTNR_ID

INNER JOIN APPPDW.ADV_CAL c
  ON TRUNC(sr.SEND_DT) = c.CAL_DT

WHERE c.FSCL_YR_NUM >= 2017
  AND sr.QUESTION_ID = 'Q1'
  AND p.STORE_NUM IN (17941,11892,10095,9734,5743,655,9688,5623,6496,6832,25349,50833,10589,10065,10067,21012,21059,14263,748,22722,9800,9801,15742,10609,10168,8573,24495,18834,10470,6227,19667,24530,23464,20263,3451,11529,23399,47904) -- MFS stores

GROUP BY
--sr.CASE_ID
--, sr.QUESTION_ID
--, TRUNC(sr.SEND_DT)
 p.STORE_NUM  
, c.FSCL_YR_NUM
, c.FSCL_PER_IN_YR_NUM


select * from APPSTG.SRV_RESPONSES_STG